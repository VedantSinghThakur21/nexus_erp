# Provisioning Service â€” Docker Exec Architecture
#
# This container runs a lightweight FastAPI service that orchestrates
# tenant provisioning by executing commands inside the existing
# Frappe backend container via `docker exec`.

services:
  provisioning:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nexus-provisioning
    restart: unless-stopped
    ports:
      - "8002:8001"
    environment:
      - BACKEND_CONTAINER=${BACKEND_CONTAINER:-frappe_docker-backend-1}
      - BENCH_PATH=/home/frappe/frappe-bench
      - MASTER_SITE_NAME=${FRAPPE_SITE_NAME:-erp.localhost}
      - PARENT_DOMAIN=${NEXT_PUBLIC_ROOT_DOMAIN:-avariq.in}
      - DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-vedant@21}
      - PROVISIONING_API_SECRET=${PROVISIONING_API_SECRET:-change-me-in-production}
      - DEFAULT_APPS=nexus_core
      - ENVIRONMENT=${NODE_ENV:-development}
    volumes:
      # Mount Docker socket so we can docker exec into the backend container
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
